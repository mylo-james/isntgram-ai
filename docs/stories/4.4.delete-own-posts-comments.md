# Story 4.4: Delete Own Posts and Comments

**Status**: Draft

## Story

**As a user**, I want to be able to delete my own posts and comments, so that I can manage the content I have created.

## Acceptance Criteria

1. A `DELETE /api/posts/{postId}` endpoint is created that only allows the post's author to delete it.
2. A `DELETE /api/comments/{commentId}` endpoint is created that only allows the comment's author to delete it.
3. On my own posts (e.g., from my profile or the detail page), a "delete" option is visible. Clicking it and confirming
   removes the post.
4. Next to my own comments, a "delete" option is visible. Clicking it removes the comment from the UI.

## Tasks / Subtasks

- [ ] **Task 1: Add Delete Post Backend Endpoint** (AC: 1)
  - [ ] Add `DELETE /api/posts/{postId}` endpoint to `apps/api/src/posts/posts.controller.ts`
  - [ ] Implement `deletePost(postId: string, userId: string)` method in `apps/api/src/posts/posts.service.ts`
  - [ ] Add authorization check to ensure only post author can delete
  - [ ] Implement soft delete or hard delete based on requirements
  - [ ] Add proper error handling and responses
  - [ ] Update related data (comments, likes) when post is deleted

- [ ] **Task 2: Add Delete Comment Backend Endpoint** (AC: 2)
  - [ ] Add `DELETE /api/comments/{commentId}` endpoint to `apps/api/src/comments/comments.controller.ts`
  - [ ] Implement `deleteComment(commentId: string, userId: string)` method in
        `apps/api/src/comments/comments.service.ts`
  - [ ] Add authorization check to ensure only comment author can delete
  - [ ] Update post comment count when comment is deleted
  - [ ] Add proper error handling and responses

- [ ] **Task 3: Create Delete Confirmation Modal** (AC: 3)
  - [ ] Create `DeleteConfirmationModal` component in `apps/web/components/common/DeleteConfirmationModal.tsx`
  - [ ] Add confirmation dialog with warning message
  - [ ] Implement confirm and cancel actions
  - [ ] Add proper styling and accessibility features
  - [ ] Handle different content types (post vs comment)

- [ ] **Task 4: Add Delete Button to Posts** (AC: 3)
  - [ ] Update `PostCard` component to show delete option for own posts
  - [ ] Update `PostDetail` component to show delete option for own posts
  - [ ] Add delete button with proper styling and positioning
  - [ ] Show delete option only for post author
  - [ ] Handle delete confirmation and API call

- [ ] **Task 5: Add Delete Button to Comments** (AC: 4)
  - [ ] Update `CommentsList` component to show delete option for own comments
  - [ ] Add delete button next to each comment (for comment author only)
  - [ ] Implement immediate comment deletion without confirmation
  - [ ] Add proper styling and hover effects
  - [ ] Handle optimistic updates for better UX

- [ ] **Task 6: Add Frontend API Integration** (AC: 3, 4)
  - [ ] Add `deletePost(postId: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Add `deleteComment(commentId: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add optimistic updates for better UX
  - [ ] Handle authentication and authorization requirements

- [ ] **Task 7: Update Redux Store for Deletions** (AC: 3, 4)
  - [ ] Add delete actions to `apps/web/lib/store/posts-slice.ts`
  - [ ] Update post state to remove deleted posts/comments
  - [ ] Implement optimistic updates for deletions
  - [ ] Handle error cases and rollback optimistic updates
  - [ ] Update comment counts and related data

- [ ] **Task 8: Add Navigation After Post Deletion** (AC: 3)
  - [ ] Handle navigation after post deletion (redirect to feed or profile)
  - [ ] Update URL and browser history appropriately
  - [ ] Show success message to user
  - [ ] Handle edge cases (deleting last post, etc.)

- [ ] **Task 9: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/common/DeleteConfirmationModal.test.tsx` with unit tests
  - [ ] Test delete functionality in PostCard and PostDetail components
  - [ ] Create backend tests for delete endpoints in `apps/api/src/posts/posts.service.test.ts`
  - [ ] Test authorization and error handling
  - [ ] Add E2E tests with Playwright for delete flows
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Epic 3 (Post Creation) provides the posts table and Post entity
- Story 4.3 (Comment on a Post) provides the comments table and Comment entity
- User authentication system fully functional with Auth.js integration
- Database schema includes users, posts, and comments tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Delete Response** [Based on architecture patterns]:

```typescript
interface DeleteResponse {
  success: boolean;
  message: string;
}
```

**Delete Confirmation Modal Props**:

```typescript
interface DeleteConfirmationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title: string;
  message: string;
  itemType: "post" | "comment";
}
```

### API Specifications

**Delete Endpoints** [Source: architecture/05-api-specification.md]:

- `DELETE /api/posts/{postId}` - Delete a post (author only)
- `DELETE /api/comments/{commentId}` - Delete a comment (author only)
- Both endpoints require authentication and author authorization
- Return success/error responses

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Backend Controllers: `apps/api/src/posts/posts.controller.ts`, `apps/api/src/comments/comments.controller.ts`
- Backend Services: `apps/api/src/posts/posts.service.ts`, `apps/api/src/comments/comments.service.ts`
- Frontend Components: `apps/web/components/common/DeleteConfirmationModal.tsx`
- Integration: `apps/web/components/posts/PostCard.tsx`, `apps/web/components/posts/PostDetail.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Redux Store: `apps/web/lib/store/posts-slice.ts`
- Tests: `apps/web/components/common/DeleteConfirmationModal.test.tsx`
- Backend Tests: `apps/api/src/posts/posts.service.test.ts`, `apps/api/src/comments/comments.service.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Cascade delete for related data (comments, likes)
- Proper foreign key constraints
- Consider soft delete vs hard delete strategy

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Authorization checks for content ownership

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- Centralized API client services layer

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/common/DeleteConfirmationModal.test.tsx`
- Backend tests: `apps/api/src/posts/posts.service.test.ts`
- Integration tests: `apps/api/test/posts.integration.test.ts`
- E2E tests: `e2e/delete-content.test.ts`

### Key Dependencies

- TypeORM for database operations and cascade deletes
- NestJS Guards for authentication and authorization
- Auth.js for session management
- Jest for testing framework
- Redux Toolkit for state management
- Shared types from `packages/shared-types`

## Testing

- Unit tests for DeleteConfirmationModal component with 80%+ coverage
- Backend tests for delete endpoints and authorization logic
- Integration tests for API endpoints with real database
- E2E tests with Playwright for delete functionality
- Test authorization and error handling
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
