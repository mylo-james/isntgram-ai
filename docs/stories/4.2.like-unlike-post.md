# Story 4.2: Like and Unlike a Post

**Status**: Draft

## Story

**As a user**, I want to like and unlike a post, so that I can show my appreciation for the content.

## Acceptance Criteria

1. Backend endpoints (`POST /api/posts/{postId}/like` and `DELETE /api/posts/{postId}/like`) are created to manage post
   likes for the authenticated user.
2. On the feed and post detail pages, a "like" icon and a visible count of total likes are displayed on each post.
3. The icon's state (e.g., filled vs. outline) correctly reflects whether I have personally liked the post.
4. Clicking the "like" icon toggles my like status for the post and updates the like count, without requiring a page
   reload.

## Tasks / Subtasks

- [ ] **Task 1: Create Like Entity and Migration** (AC: 1)
  - [ ] Create `Like` entity in `apps/api/src/likes/entities/like.entity.ts` with TypeORM decorators
  - [ ] Define fields: id, userId, likeableId, likeableType, createdAt
  - [ ] Add polymorphic relationship for posts and comments (future stories)
  - [ ] Create migration file for likes table with proper indexes
  - [ ] Add unique constraint on userId + likeableId + likeableType

- [ ] **Task 2: Create Likes Service** (AC: 1)
  - [ ] Create `LikesService` in `apps/api/src/likes/likes.service.ts`
  - [ ] Implement `likePost(userId: string, postId: string)` method
  - [ ] Implement `unlikePost(userId: string, postId: string)` method
  - [ ] Add validation to prevent duplicate likes
  - [ ] Add proper error handling for edge cases
  - [ ] Update post like count when likes are added/removed

- [ ] **Task 3: Create Likes Controller** (AC: 1)
  - [ ] Create `LikesController` in `apps/api/src/likes/likes.controller.ts`
  - [ ] Implement `POST /api/posts/{postId}/like` endpoint
  - [ ] Implement `DELETE /api/posts/{postId}/like` endpoint
  - [ ] Add authentication guard to both endpoints
  - [ ] Add proper request validation and error responses
  - [ ] Add OpenAPI documentation for endpoints

- [ ] **Task 4: Create Likes Module** (AC: 1)
  - [ ] Create `LikesModule` in `apps/api/src/likes/likes.module.ts`
  - [ ] Configure TypeORM repository for Like entity
  - [ ] Register service and controller in module
  - [ ] Export service for use in other modules
  - [ ] Import module in main AppModule

- [ ] **Task 5: Update Post Entity for Like Count** (AC: 2)
  - [ ] Update `Post` entity to include `likesCount` field
  - [ ] Add method to increment/decrement like count
  - [ ] Ensure like count is updated when likes are added/removed
  - [ ] Add proper database triggers or service methods for count updates

- [ ] **Task 6: Create Like Button Component** (AC: 2, 3, 4)
  - [ ] Create `LikeButton` component in `apps/web/components/posts/LikeButton.tsx`
  - [ ] Implement like/unlike icon states (filled vs. outline)
  - [ ] Display like count with proper formatting
  - [ ] Add click handler for like/unlike functionality
  - [ ] Add loading states and error handling
  - [ ] Ensure accessibility features

- [ ] **Task 7: Integrate Like Button with Posts** (AC: 2, 3, 4)
  - [ ] Update `PostCard` component to include LikeButton
  - [ ] Update `PostDetail` component to include LikeButton
  - [ ] Pass current user's like status to LikeButton
  - [ ] Handle like/unlike state changes in parent components
  - [ ] Update post data after successful like/unlike

- [ ] **Task 8: Add Frontend API Integration** (AC: 4)
  - [ ] Add `likePost(postId: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Add `unlikePost(postId: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add optimistic updates for better UX
  - [ ] Handle authentication requirements

- [ ] **Task 9: Update Redux Store for Like State** (AC: 4)
  - [ ] Add like/unlike actions to `apps/web/lib/store/posts-slice.ts`
  - [ ] Update post state to include like status and count
  - [ ] Implement optimistic updates for like actions
  - [ ] Handle error cases and rollback optimistic updates
  - [ ] Ensure state consistency across components

- [ ] **Task 10: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/posts/LikeButton.test.tsx` with unit tests
  - [ ] Test like/unlike functionality and icon states
  - [ ] Create backend tests for likes endpoints in `apps/api/src/likes/likes.service.test.ts`
  - [ ] Test API integration and error handling
  - [ ] Add E2E tests with Playwright for like/unlike flow
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Epic 3 (Post Creation) provides the posts table and Post entity
- Story 4.1 (Single Post Detail Page) provides the PostDetail component
- User authentication system fully functional with Auth.js integration
- Database schema includes users and posts tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Like Entity** [Source: architecture/04-data-models.md#like]:

```typescript
export type LikeableType = "POST" | "COMMENT";

export interface Like {
  id: string;
  userId: string;
  likeableId: string;
  likeableType: LikeableType;
  createdAt: Date;
}
```

**Like Button Props**:

```typescript
interface LikeButtonProps {
  postId: string;
  isLiked: boolean;
  likeCount: number;
  onLikeChange: (isLiked: boolean, newCount: number) => void;
  disabled?: boolean;
}
```

### API Specifications

**Like Endpoints** [Source: architecture/05-api-specification.md]:

- `POST /api/posts/{postId}/like` - Like a post (requires authentication)
- `DELETE /api/posts/{postId}/like` - Unlike a post (requires authentication)
- Both endpoints return success/error responses
- Like count is updated in post data

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Entity: `apps/api/src/likes/entities/like.entity.ts`
- Service: `apps/api/src/likes/likes.service.ts`
- Controller: `apps/api/src/likes/likes.controller.ts`
- Module: `apps/api/src/likes/likes.module.ts`
- Frontend Component: `apps/web/components/posts/LikeButton.tsx`
- Integration: `apps/web/components/posts/PostCard.tsx`, `apps/web/components/posts/PostDetail.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Redux Store: `apps/web/lib/store/posts-slice.ts`
- Tests: `apps/web/components/posts/LikeButton.test.tsx`
- Backend Tests: `apps/api/src/likes/likes.service.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Likes table with polymorphic relationships
- Unique constraint on userId + likeableId + likeableType
- Foreign key constraints to users table
- Denormalized like count in posts table

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Global exception filter for consistent error responses

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- Centralized API client services layer

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/posts/LikeButton.test.tsx`
- Backend tests: `apps/api/src/likes/likes.service.test.ts`
- Integration tests: `apps/api/test/likes.integration.test.ts`
- E2E tests: `e2e/like-post.test.ts`

### Key Dependencies

- TypeORM for database operations and polymorphic relationships
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Redux Toolkit for state management
- Shared types from `packages/shared-types`

## Testing

- Unit tests for LikeButton component with 80%+ coverage
- Backend tests for likes endpoints and service logic
- Integration tests for API endpoints with real database
- E2E tests with Playwright for like/unlike functionality
- Test optimistic updates and error handling
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
