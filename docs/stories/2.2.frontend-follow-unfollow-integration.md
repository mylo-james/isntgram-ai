# Story 2.2: Frontend Follow/Unfollow Integration

**Status**: Draft

## Story

**As a user**, I want to click the "Follow" button on another user's profile to follow them, and click it again to
unfollow them, so that I can manage my social connections.

## Acceptance Criteria

1. On another user's profile, the button correctly shows "Follow" if I am not following them, and "Following" if I am.
2. Clicking the "Follow" button calls the POST endpoint, and on success, the button's state and text updates to
   "Following" without a page reload.
3. Clicking the "Following" button calls the DELETE endpoint, and on success, the button's state and text updates to
   "Follow" without a page reload.
4. The button is disabled and shows a loading indicator while the API call is in progress.

## Tasks / Subtasks

- [ ] **Task 1: Create Follow Button Component** (AC: 1, 4)
  - [ ] Create `FollowButton` component in `apps/web/components/profile/FollowButton.tsx`
  - [ ] Implement button states: "Follow", "Following", "Loading"
  - [ ] Add proper styling with Tailwind CSS
  - [ ] Add loading spinner/indicator for loading state
  - [ ] Add hover effects and accessibility features
  - [ ] Ensure button works on mobile and desktop

- [ ] **Task 2: Create Follow API Client Methods** (AC: 2, 3)
  - [ ] Add `followUser(username: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Add `unfollowUser(username: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and response types
  - [ ] Add loading state management for API calls
  - [ ] Ensure methods use authenticated requests

- [ ] **Task 3: Integrate Follow Button with Profile Page** (AC: 1, 2, 3)
  - [ ] Update `apps/web/app/[username]/components/ProfileActions.tsx` to include FollowButton
  - [ ] Pass current user's follow status to FollowButton component
  - [ ] Handle follow/unfollow state changes in ProfileActions
  - [ ] Update user profile data after successful follow/unfollow
  - [ ] Add proper error handling and user feedback

- [ ] **Task 4: Update Redux Store for Follow State** (AC: 2, 3)
  - [ ] Add follow/unfollow actions to `apps/web/lib/store/auth-slice.ts`
  - [ ] Update user state to include following relationships
  - [ ] Implement optimistic updates for better UX
  - [ ] Handle error cases and rollback optimistic updates
  - [ ] Ensure state consistency across components

- [ ] **Task 5: Add User Feedback and Error Handling** (AC: 4)
  - [ ] Add toast notifications for success/error states
  - [ ] Implement proper error messages for different failure scenarios
  - [ ] Add retry functionality for failed requests
  - [ ] Ensure loading states are properly managed
  - [ ] Add accessibility announcements for screen readers

- [ ] **Task 6: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/profile/FollowButton.test.tsx` with unit tests
  - [ ] Test all button states and interactions
  - [ ] Test API integration and error handling
  - [ ] Create integration tests for ProfileActions with FollowButton
  - [ ] Add E2E tests with Playwright for complete follow/unfollow flow
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Story 2.1 (Follow/Unfollow Backend Logic) provides the API endpoints this story depends on
- Backend endpoints: `POST /api/users/{username}/follow` and `DELETE /api/users/{username}/follow`
- Authentication system fully functional with Auth.js integration
- User profile page already implemented with dynamic routing
- Redux store configured for user state management

### Data Models

**Follow Button Props** [Based on architecture patterns]:

```typescript
interface FollowButtonProps {
  username: string;
  isFollowing: boolean;
  isOwnProfile: boolean;
  onFollowChange: (isFollowing: boolean) => void;
  disabled?: boolean;
}
```

**API Response Types** [Source: architecture/04-data-models.md]:

- Follow/unfollow endpoints return success/error responses
- User profile includes `followerCount` and `followingCount` fields

### API Specifications

**Follow Endpoints** [Source: architecture/05-api-specification.md]:

- `POST /api/users/{username}/follow` - Follow a user (returns success/error)
- `DELETE /api/users/{username}/follow` - Unfollow a user (returns success/error)
- Both endpoints require authentication and return appropriate HTTP status codes

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Component: `apps/web/components/profile/FollowButton.tsx`
- Integration: `apps/web/app/[username]/components/ProfileActions.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Redux Store: `apps/web/lib/store/auth-slice.ts`
- Tests: `apps/web/components/profile/FollowButton.test.tsx`
- E2E Tests: `e2e/follow-unfollow.test.ts`

### Technical Constraints

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- TypeScript strict mode with no implicit any

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- Use shared types from `packages/shared-types`
- Immutable updates, no direct mutations
- JSDoc comments for all public APIs
- Co-located tests with source code

**Component Patterns** [Source: architecture/06-components.md]:

- Feature-sliced component organization
- Modern component template with styling after component logic
- Centralized API client services layer

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: Component integration testing with mocked API calls (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/profile/FollowButton.test.tsx`
- Integration tests: `apps/web/app/[username]/components/ProfileActions.test.tsx`
- E2E tests: `e2e/follow-unfollow.test.ts`
- Test utilities: `apps/web/lib/test-utils.tsx`

### Key Dependencies

- React Testing Library for component testing
- Redux Toolkit for state management
- Tailwind CSS for styling
- Auth.js for authentication
- Shared types from `packages/shared-types`

## Testing

- Unit tests for FollowButton component with 80%+ coverage
- Integration tests for ProfileActions with FollowButton integration
- E2E tests with Playwright for complete follow/unfollow user flow
- Test all button states: Follow, Following, Loading, Error
- Test API integration, error handling, and optimistic updates
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
