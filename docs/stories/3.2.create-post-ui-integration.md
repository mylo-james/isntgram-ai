# Story 3.2: Create Post UI and Integration

**Status**: Draft

## Story

**As a user**, I want a simple interface to upload an image and write a caption, so that I can create a new post.

## Acceptance Criteria

1. A "Create Post" button or icon is available in the main navigation.
2. Clicking this button opens a modal for creating a new post.
3. The modal contains a file input for an image and a textarea for the caption.
4. After an image is selected and successfully uploaded to the storage provider, the user can submit the post (caption
   and the returned image URL) to the `POST /api/posts` endpoint.
5. Upon successful creation, the modal closes, and the user is redirected to the main feed, where their new post should
   appear at the top.

## Tasks / Subtasks

- [ ] **Task 1: Create Create Post Modal Component** (AC: 2, 3)
  - [ ] Create `CreatePostModal` component in `apps/web/components/posts/CreatePostModal.tsx`
  - [ ] Implement modal dialog with proper backdrop and close functionality
  - [ ] Add file input for image selection with drag-and-drop support
  - [ ] Add textarea for caption with character limit display
  - [ ] Add image preview functionality
  - [ ] Ensure accessibility features (keyboard navigation, screen reader support)

- [ ] **Task 2: Create Image Upload Service** (AC: 4)
  - [ ] Create `ImageUploadService` in `apps/web/lib/image-upload.ts`
  - [ ] Implement image upload to storage provider (S3 or similar)
  - [ ] Add image validation (file type, size limits)
  - [ ] Add image compression/optimization
  - [ ] Handle upload progress and error states
  - [ ] Return image URL for post creation

- [ ] **Task 3: Add Create Post Button to Navigation** (AC: 1)
  - [ ] Update `apps/web/app/layout.tsx` to include Create Post button
  - [ ] Add button to main navigation bar
  - [ ] Style button with appropriate icon and hover effects
  - [ ] Ensure button is only visible to authenticated users
  - [ ] Add proper accessibility labels

- [ ] **Task 4: Create Post API Integration** (AC: 4)
  - [ ] Add `createPost(postData: CreatePostData)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add request validation before submission
  - [ ] Handle API response and success/error states
  - [ ] Ensure authenticated requests

- [ ] **Task 5: Integrate Modal with State Management** (AC: 2, 4, 5)
  - [ ] Add modal state management to Redux store
  - [ ] Implement open/close actions for CreatePostModal
  - [ ] Handle form state and validation
  - [ ] Manage loading states during upload and submission
  - [ ] Handle success/error feedback to user

- [ ] **Task 6: Add Form Validation and UX** (AC: 3, 4)
  - [ ] Add client-side validation for image and caption
  - [ ] Implement character counter for caption
  - [ ] Add loading indicators during upload and submission
  - [ ] Add success/error toast notifications
  - [ ] Implement form reset after successful submission

- [ ] **Task 7: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/posts/CreatePostModal.test.tsx` with unit tests
  - [ ] Test modal open/close functionality and form interactions
  - [ ] Test image upload functionality and validation
  - [ ] Test API integration and error handling
  - [ ] Add E2E tests with Playwright for complete post creation flow
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Story 3.1 (Create Post Backend) provides the `POST /api/posts` endpoint
- User authentication system fully functional with Auth.js integration
- Redux store configured for user state management
- Navigation system already implemented with layout structure
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Create Post Data** [Based on Story 3.1]:

```typescript
interface CreatePostData {
  imageUrl: string;
  caption?: string;
}
```

**Modal Component Props**:

```typescript
interface CreatePostModalProps {
  isOpen: boolean;
  onClose: () => void;
  onPostCreated: (post: Post) => void;
}
```

**Image Upload Response**:

```typescript
interface ImageUploadResponse {
  imageUrl: string;
  success: boolean;
  error?: string;
}
```

### API Specifications

**Post Creation Endpoint** [Source: architecture/05-api-specification.md]:

- `POST /api/posts` - Create a new post (requires authentication)
- Request body: `{ imageUrl: string, caption?: string }`
- Response: Created post object with author information

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Modal Component: `apps/web/components/posts/CreatePostModal.tsx`
- Image Upload Service: `apps/web/lib/image-upload.ts`
- Navigation Integration: `apps/web/app/layout.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Redux Store: `apps/web/lib/store/posts-slice.ts`
- Tests: `apps/web/components/posts/CreatePostModal.test.tsx`
- E2E Tests: `e2e/create-post.test.ts`

### Technical Constraints

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- Centralized API client services layer

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- Immutable updates, no direct mutations
- JSDoc comments for all public APIs
- Co-located tests with source code

**Component Patterns** [Source: architecture/06-components.md]:

- Feature-sliced component organization
- Modern component template with styling after component logic
- Modal components with proper backdrop and accessibility

**Image Upload Requirements**:

- Support for common image formats (JPEG, PNG, WebP)
- File size limits (e.g., 10MB max)
- Image compression for optimization
- Drag-and-drop functionality
- Progress indicators during upload

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: Component integration testing with mocked API calls (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/posts/CreatePostModal.test.tsx`
- Integration tests: `apps/web/lib/image-upload.test.ts`
- E2E tests: `e2e/create-post.test.ts`
- Test utilities: `apps/web/lib/test-utils.tsx`

### Key Dependencies

- React Testing Library for component testing
- Redux Toolkit for state management
- Tailwind CSS for styling
- Auth.js for authentication
- Image upload service (S3 or similar)
- Shared types from `packages/shared-types`

## Testing

- Unit tests for CreatePostModal component with 80%+ coverage
- Integration tests for image upload functionality
- E2E tests with Playwright for complete post creation flow
- Test modal open/close, form validation, and image upload
- Test API integration, error handling, and success flows
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
