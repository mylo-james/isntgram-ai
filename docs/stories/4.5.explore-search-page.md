# Story 4.5: Explore and Search Page

**Status**: Draft

## Story

**As a user**, I want an explore page with a search bar, so that I can discover new users, posts, and content via
hashtags.

## Acceptance Criteria

1. Backend search endpoints are created to find users (by username) and posts (by hashtags within the caption).
2. An `/explore` page is created that initially shows a grid of recent posts from all users, providing a discovery
   mechanism distinct from the main feed.
3. The page includes a search bar.
4. Executing a search displays results for matching users and posts.
5. Hashtags (e.g., #react) in post captions are rendered as clickable links.
6. Clicking a hashtag link navigates to a search results page for that specific tag.

## Tasks / Subtasks

- [ ] **Task 1: Create Search Backend Endpoints** (AC: 1)
  - [ ] Add `GET /api/search` endpoint to `apps/api/src/search/search.controller.ts`
  - [ ] Implement `searchUsers(query: string)` method in `apps/api/src/search/search.service.ts`
  - [ ] Implement `searchPosts(query: string)` method for hashtag search
  - [ ] Add pagination support for search results
  - [ ] Add proper error handling and validation

- [ ] **Task 2: Create Search Service** (AC: 1)
  - [ ] Create `SearchService` in `apps/api/src/search/search.service.ts`
  - [ ] Implement full-text search for usernames
  - [ ] Implement hashtag extraction and search from post captions
  - [ ] Add search result ranking and relevance scoring
  - [ ] Handle edge cases (empty queries, no results)

- [ ] **Task 3: Create Search Module** (AC: 1)
  - [ ] Create `SearchModule` in `apps/api/src/search/search.module.ts`
  - [ ] Configure search service and controller
  - [ ] Add database indexes for search optimization
  - [ ] Export search service for use in other modules
  - [ ] Import module in main AppModule

- [ ] **Task 4: Create Explore Page** (AC: 2)
  - [ ] Create `apps/web/app/explore/page.tsx` with explore layout
  - [ ] Implement grid layout for recent posts from all users
  - [ ] Add pagination for explore feed
  - [ ] Handle loading and error states
  - [ ] Add proper SEO metadata

- [ ] **Task 5: Create Search Component** (AC: 3, 4)
  - [ ] Create `SearchBar` component in `apps/web/components/search/SearchBar.tsx`
  - [ ] Add search input with autocomplete suggestions
  - [ ] Implement search debouncing for performance
  - [ ] Add search history and recent searches
  - [ ] Ensure accessibility features

- [ ] **Task 6: Create Search Results Page** (AC: 4, 6)
  - [ ] Create `apps/web/app/search/page.tsx` with dynamic search results
  - [ ] Display users and posts in separate sections
  - [ ] Add filtering options (users only, posts only, all)
  - [ ] Implement pagination for search results
  - [ ] Handle empty search results gracefully

- [ ] **Task 7: Create Hashtag Component** (AC: 5, 6)
  - [ ] Create `HashtagLink` component in `apps/web/components/posts/HashtagLink.tsx`
  - [ ] Extract hashtags from post captions using regex
  - [ ] Render hashtags as clickable links
  - [ ] Navigate to search results page for hashtag
  - [ ] Add proper styling and hover effects

- [ ] **Task 8: Update Post Components for Hashtags** (AC: 5)
  - [ ] Update `PostCard` component to render hashtags
  - [ ] Update `PostDetail` component to render hashtags
  - [ ] Integrate `HashtagLink` component in post captions
  - [ ] Ensure hashtags are properly styled and clickable
  - [ ] Add hashtag extraction utility functions

- [ ] **Task 9: Add Frontend API Integration** (AC: 4)
  - [ ] Add `searchUsers(query: string, page?: number)` method to `apps/web/lib/api-client.ts`
  - [ ] Add `searchPosts(query: string, page?: number)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add search result caching for better performance
  - [ ] Handle authentication requirements

- [ ] **Task 10: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/search/SearchBar.test.tsx` with unit tests
  - [ ] Create `apps/web/components/posts/HashtagLink.test.tsx` with unit tests
  - [ ] Test search functionality and result display
  - [ ] Create backend tests for search endpoints in `apps/api/src/search/search.service.test.ts`
  - [ ] Add E2E tests with Playwright for search and explore flows
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Epic 3 (Post Creation) provides the posts table and Post entity
- Epic 2 (Social Graph) provides the users table and User entity
- User authentication system fully functional with Auth.js integration
- Database schema includes users and posts tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Search Response** [Based on architecture patterns]:

```typescript
interface SearchResponse {
  users: Array<{
    id: string;
    username: string;
    fullName: string;
    profilePictureUrl?: string;
  }>;
  posts: Array<{
    id: string;
    imageUrl: string;
    caption?: string;
    author: {
      id: string;
      username: string;
      fullName: string;
    };
  }>;
  pagination: {
    page: number;
    limit: number;
    total: number;
    hasMore: boolean;
  };
}
```

**Hashtag Extraction**:

```typescript
interface HashtagMatch {
  tag: string;
  startIndex: number;
  endIndex: number;
}
```

### API Specifications

**Search Endpoints** [Source: architecture/05-api-specification.md]:

- `GET /api/search` - Search users and posts
- Query parameters: `q` (search query), `type` (users/posts/all), `page`, `limit`
- Response: Paginated search results for users and posts

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Backend Controller: `apps/api/src/search/search.controller.ts`
- Backend Service: `apps/api/src/search/search.service.ts`
- Backend Module: `apps/api/src/search/search.module.ts`
- Frontend Pages: `apps/web/app/explore/page.tsx`, `apps/web/app/search/page.tsx`
- Frontend Components: `apps/web/components/search/SearchBar.tsx`, `apps/web/components/posts/HashtagLink.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Tests: `apps/web/components/search/SearchBar.test.tsx`
- Backend Tests: `apps/api/src/search/search.service.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Full-text search indexes for usernames
- Hashtag extraction and indexing for post captions
- Proper indexing for search performance

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Search optimization and relevance scoring

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- Centralized API client services layer

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/search/SearchBar.test.tsx`
- Backend tests: `apps/api/src/search/search.service.test.ts`
- Integration tests: `apps/api/test/search.integration.test.ts`
- E2E tests: `e2e/search-explore.test.ts`

### Key Dependencies

- TypeORM for database operations and full-text search
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Redux Toolkit for state management
- Shared types from `packages/shared-types`

## Testing

- Unit tests for SearchBar and HashtagLink components with 80%+ coverage
- Backend tests for search endpoints and service logic
- Integration tests for API endpoints with real database
- E2E tests with Playwright for search and explore functionality
- Test hashtag extraction and search functionality
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
