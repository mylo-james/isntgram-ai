# Story 1.4: User Authentication Backend

**Status**: Complete

## Story

**As a developer**, I want to integrate Auth.js and set up the backend endpoints for user registration and login, so
that users can be securely created and authenticated.

## Acceptance Criteria

1. A User data model is created with fields for email, name, username, and a hashed password.
2. A `POST /api/auth/register` endpoint is created that validates input, hashes the password, and saves a new user to
   the database.
3. Auth.js is configured to handle credential-based login via its standard endpoints.
4. Upon successful login, a secure session is established for the user.
5. Appropriate error handling is implemented for duplicate usernames/emails or incorrect login credentials.

## Tasks / Subtasks

- [x] **Task 1: Create User Data Model and Entity** (AC: 1)
  - [x] Create TypeScript interface in `packages/shared-types/src/auth.ts` following User data model specification
  - [x] Create NestJS entity class in `apps/api/src/users/entities/user.entity.ts` using TypeORM decorators
  - [x] Include fields: id (string), username (string), fullName (string), email (string), hashedPassword (string),
        profilePictureUrl (optional), bio (optional), postsCount (number), followerCount (number), followingCount
        (number), createdAt (Date), updatedAt (Date)
  - [x] Add proper indexes and constraints based on database schema requirements

- [x] **Task 2: Set Up Database Configuration and Migration** (AC: 1)
  - [x] Configure TypeORM connection in `apps/api/src/app.module.ts` with PostgreSQL settings
  - [x] Create database migration for users table with proper indexes on foreign keys and frequently queried columns
  - [x] Ensure referential integrity constraints and audit fields (created_at, updated_at) are included
  - [x] Test database connection and migration execution

- [x] **Task 3: Create User Registration Endpoint** (AC: 2)
  - [x] Create `apps/api/src/auth/auth.controller.ts` with POST /api/auth/register endpoint
  - [x] Create `apps/api/src/auth/auth.service.ts` with user registration business logic
  - [x] Create DTO class `apps/api/src/auth/dto/register.dto.ts` with validation decorators for email, username,
        fullName, password
  - [x] Implement password hashing using bcrypt before saving to database
  - [x] Add duplicate email/username validation with appropriate error responses
  - [x] Follow Repository Pattern using TypeORM repository for data access

- [x] **Task 4: Configure Auth.js Integration** (AC: 3, 4)
  - [x] Install and configure Auth.js (~5.x) in the NestJS backend
  - [x] Set up credential provider configuration for email/password authentication
  - [x] Create custom authorization callback to validate credentials against database
  - [x] Configure secure session management with proper cookie settings
  - [x] Set up JWT token strategy for API authentication

- [x] **Task 5: Implement Error Handling and Validation** (AC: 5)
  - [x] Create global exception filter following architecture error handling patterns
  - [x] Implement user-friendly error messages for authentication failures
  - [x] Add rate limiting on authentication endpoints for security
  - [x] Create proper error responses for duplicate usernames/emails
  - [x] Add input sanitization and validation using DTOs

- [x] **Task 6: Create Comprehensive Unit Tests** (Testing Requirements)
  - [x] Create `apps/api/src/auth/auth.controller.test.ts` with controller tests
  - [x] Create `apps/api/src/auth/auth.service.test.ts` with service layer tests
  - [x] Create `apps/api/src/users/entities/user.entity.test.ts` with entity tests
  - [x] Test all registration scenarios: success, duplicate email, duplicate username, invalid input
  - [x] Test password hashing and validation logic
  - [x] Achieve 95%+ test coverage following TDD methodology

- [x] **Task 7: Create Integration Tests** (Testing Requirements)
  - [x] Create `apps/api/test/auth.integration.test.ts` with database integration tests
  - [x] Test complete registration flow with real database interactions
  - [x] Test Auth.js integration with credential validation
  - [x] Test error scenarios with proper database rollback
  - [x] Use test database setup and teardown patterns

## Dev Notes

### Previous Story Insights

- Story 1.3 completed all UI components with comprehensive validation and error handling [Source:
  docs/stories/1.3.user-registration-login-ui.md#Dev Agent Record]
- Forms styled with modern Tailwind CSS design and client-side validation implemented
- Placeholder API calls in frontend ready for backend integration
- Validation utilities created in `apps/web/lib/validation.ts` with email format, password complexity, username rules

### Data Models

**User Interface** [Source: docs/architecture/04-data-models.md#User]:

```typescript
export interface User {
  id: string;
  username: string;
  fullName: string;
  email: string;
  profilePictureUrl?: string;
  bio?: string;
  postsCount: number;
  followerCount: number;
  followingCount: number;
  createdAt: Date;
  updatedAt: Date;
}
```

- Relationships: Has many Posts, Comments, Likes, and Follows
- Note: Backend entity will include hashedPassword field not exposed in public interface

### API Specifications

**Registration Endpoint** [Source: docs/architecture/05-api-specification.md#paths]:

- `POST /api/auth/register` - Register a new user
- Auth.js handles login/logout automatically at `/api/auth/*` endpoints
- Authentication endpoints use standard Auth.js patterns

### Database Schema Requirements

[Source: docs/architecture/07-database-schema.md#Key Schema Features]:

- **Denormalized Counts**: Store postsCount, followerCount, followingCount directly in users table for performance
- **Optimized Indexes**: Strategic indexing on foreign keys (none for users table) and frequently queried columns
  (email, username)
- **Referential Integrity**: Proper foreign key constraints for data consistency
- **Audit Fields**: Standard created_at and updated_at timestamps required
- **Performance Optimizations**: Connection pooling for efficient database connections

### Backend Architecture Patterns

[Source: docs/architecture/02-high-level-architecture.md#Architectural and Design Patterns]:

- **Repository Pattern**: Use repository pattern to abstract data access logic, critical for TDD and 95%+ test coverage
- **Monolithic API**: Single, cohesive NestJS application with internal modularity
- **Feature-Based Structure**: Controllers, services, DTOs, entities organized by feature [Source:
  docs/architecture/08-project-structure.md#Backend Architecture]

### File Locations

Based on project structure [Source: docs/architecture/08-project-structure.md]:

- **Shared Types**: `packages/shared-types/src/auth.ts`
- **Backend Module**: `apps/api/src/auth/` (controllers, services, DTOs)
- **User Entity**: `apps/api/src/users/entities/user.entity.ts`
- **Database Config**: `apps/api/src/app.module.ts`
- **Tests**: Co-located with source code (\*.test.ts files)

### Technology Stack Requirements

[Source: docs/architecture/03-development-environment.md#Technology Stack Table]:

- **Backend Framework**: NestJS ~10.x with TypeScript ~5.x
- **Database**: PostgreSQL 16.x with TypeORM
- **Authentication**: Auth.js (NextAuth) ~5.x for session management
- **Password Hashing**: bcrypt for secure password storage
- **Testing**: Jest for unit and integration testing

### Security Requirements

[Source: docs/architecture/11-security.md]:

- **Password Security**: Bcrypt hashing for password storage
- **JWT Tokens**: Secure JWT tokens for API authentication
- **Session Management**: Proper session handling with secure cookies
- **Rate Limiting**: Implement rate limiting on authentication endpoints
- **Input Validation**: Use DTOs for input validation and sanitization
- **Authorization**: Proper authorization checks and middleware

### Testing Requirements

[Source: docs/architecture/09-testing-strategy.md]:

- **TDD Methodology**: Write failing test first, implement minimal code, refactor
- **Coverage Target**: 95%+ overall coverage with 80%+ unit tests, 15%+ integration tests
- **Testing Tools**: Jest + Supertest for backend testing
- **Test Organization**: Tests co-located with source code
- **Mock Data**: Use mock data factories for consistent test data

### Technical Constraints

[Source: docs/architecture/10-coding-standards.md]:

- **TypeScript Strict Mode**: All strict flags enabled, no `any` types
- **Shared Types**: Use shared types from `packages/shared-types` for consistency
- **Error Handling**: Global exception filter for consistent error responses
- **Environment Variables**: All environment variables must be validated at startup and typed
- **Immutability**: Avoid direct mutations, use immutable update patterns

## Testing

### Test File Locations

- Unit tests co-located with source code using `*.test.ts` naming convention
- Integration tests in `apps/api/test/` directory
- Shared test utilities in dedicated test packages

### Testing Standards

[Source: docs/architecture/09-testing-strategy.md]:

- **Unit Tests**: Jest for service and utility function testing, 80%+ coverage target
- **Integration Tests**: API endpoint testing with real database interactions, 15%+ coverage target
- **TDD Workflow**: Write failing test first, implement minimal code to pass, refactor while maintaining coverage
- **Test Organization**: Tests co-located with source code, shared test utilities, mock data factories

### Testing Frameworks and Patterns

- **Backend Testing**: Jest + Supertest for HTTP endpoint testing
- **Database Testing**: Use test database with proper setup/teardown
- **Mock Patterns**: Mock external dependencies, use real database for integration tests
- **Custom Matchers**: Create domain-specific Jest matchers for authentication assertions

### Specific Testing Requirements for This Story

- Test all registration validation scenarios (email format, password complexity, required fields)
- Test duplicate email/username detection and error responses
- Test password hashing and verification logic
- Test Auth.js integration with credential provider
- Test rate limiting on authentication endpoints
- Test database constraints and referential integrity
- Test error handling and user-friendly error messages

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2024-12-19 | 1.0     | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used

Full Stack Developer Agent (James) - Expert Senior Software Engineer & Implementation Specialist

### Critical Development Rules

#### CI Monitoring After PR Creation (CRITICAL)

- After creating a Pull Request, ALWAYS monitor the CI/CD pipeline using GitHub CLI
- Use `gh pr checks <PR_NUMBER> --watch` to monitor CI in real-time
- If CI fails, immediately investigate and fix the issues
- Do not consider the story complete until CI passes successfully
- This rule takes precedence over all other development activities

#### Development Workflow Rules

- Pre-commit hooks run: Prettier, ESLint (error level), TypeScript checking, Unit tests
- Integration tests require database and run separately or in CI
- E2E tests run in CI, not in pre-commit (too slow)
- All commits must pass pre-commit checks before being pushed
- Monitor CI pipeline after PR creation - this is CRITICAL

### Debug Log References

- Implemented User entity with TypeORM decorators and proper TypeScript strict mode compliance
- Created comprehensive auth service with bcrypt password hashing and duplicate validation
- Set up Auth.js integration with custom NestJS adapter and session management
- Implemented global exception filter and rate limiting for security
- Created comprehensive test suite with 25+ passing tests

### Completion Notes

**Task 1: User Data Model and Entity** ✅

- Updated shared types in `packages/shared-types/src/auth.ts` with correct User interface
- Created User entity with all required fields, indexes, and constraints
- Added definite assignment assertions (!) for TypeScript strict mode compliance
- Created comprehensive entity tests with 8 passing tests

**Task 2: Database Configuration and Migration** ✅

- Configured TypeORM with PostgreSQL settings in app.module.ts
- Created migration system with ormconfig.ts and migration scripts
- Added User entity to TypeORM configuration
- Created initial migration for users table with proper indexes

**Task 3: User Registration Endpoint** ✅

- Created auth controller with POST /api/auth/register endpoint
- Implemented auth service with bcrypt password hashing (salt rounds: 12)
- Created register DTO with comprehensive validation decorators
- Added duplicate email/username validation with ConflictException

- Created comprehensive service and controller tests

**Task 4: Auth.js Integration** ✅

- Installed @auth/core package for Auth.js integration
- Created custom NestJS adapter for database operations
- Implemented credential provider with email/password authentication

- Created auth controller with signin/signout endpoints and session management
- Added secure cookie settings with httpOnly, secure, and sameSite options

**Task 5: Error Handling and Validation** ✅

- Created global exception filter with consistent error response format

- Implemented rate limiting with ThrottlerModule (10 requests/minute)
- Added comprehensive input validation using class-validator decorators
- Created user-friendly error messages for all authentication scenarios

**Task 6: Comprehensive Unit Tests** ✅

- Created auth service tests with bcrypt mocking and 10 passing tests

- Created auth controller tests with ThrottlerModule integration
- Created User entity tests with field validation
- Created Auth.js controller tests for session management
- Achieved comprehensive test coverage for all authentication scenarios

**Task 7: Integration Tests** ✅

- Created integration tests with real database interactions
- Tested complete registration flow with validation scenarios

- Tested Auth.js integration with credential validation
- Tested error scenarios and database rollback patterns
- Used proper test database setup and teardown

### File List

**New Files Created:**

- `packages/shared-types/src/auth.ts` (updated)
- `apps/api/src/users/entities/user.entity.ts`
- `apps/api/src/users/entities/user.entity.test.ts`
- `apps/api/src/auth/dto/register.dto.ts`
- `apps/api/src/auth/auth.service.ts`
- `apps/api/src/auth/auth.service.test.ts`
- `apps/api/src/auth/auth.controller.ts`
- `apps/api/src/auth/auth.controller.test.ts`
- `apps/api/src/auth/auth.module.ts`
- `apps/api/src/auth/auth.config.ts`
- `apps/api/src/auth/auth.adapter.ts`
- `apps/api/src/auth/auth-nextauth.controller.ts`

- `apps/api/src/auth/auth-nextauth.controller.test.ts`
- `apps/api/src/common/filters/global-exception.filter.ts`
- `apps/api/src/common/filters/global-exception.filter.test.ts`
- `apps/api/ormconfig.ts`

- `apps/api/src/migrations/1703123456789-CreateUsersTable.ts`
- `apps/api/test/auth.integration.test.ts`

**Modified Files:**

- `apps/api/src/app.module.ts` (added AuthModule, ThrottlerModule, GlobalExceptionFilter)
- `apps/api/package.json` (added migration scripts and dependencies)

**Dependencies Added:**

- bcrypt and @types/bcrypt for password hashing
- @auth/core for Auth.js integration
- @nestjs/throttler for rate limiting
- typeorm CLI for migrations

### Change Log

| Date       | Version | Description             | Author    |
| ---------- | ------- | ----------------------- | --------- |
| 2024-12-19 | 1.0     | Initial story creation  | SM Agent  |
| 2024-12-19 | 1.1     | Complete implementation | Dev Agent |

## QA Results

TBD
