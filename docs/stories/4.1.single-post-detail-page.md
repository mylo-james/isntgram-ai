# Story 4.1: Single Post Detail Page

**Status**: Draft

## Story

**As a user**, I want to click on a post in the feed to view a dedicated detail page, so that I can see the post and all
of its comments in one focused view.

## Acceptance Criteria

1. A `GET /api/posts/{postId}` endpoint is created that retrieves all data for a single post, including author
   information and a list of all its comments.
2. A dynamic route `posts/{postId}` is created on the frontend.
3. Clicking on a post from the main feed or a user's profile navigates to this new page.
4. The page displays the post image, author details, caption, and a full list of comments below it.
5. The page correctly handles the case where a post ID is invalid or not found.

## Tasks / Subtasks

- [ ] **Task 1: Create Single Post Backend Endpoint** (AC: 1)
  - [ ] Add `GET /api/posts/{postId}` endpoint to `apps/api/src/posts/posts.controller.ts`
  - [ ] Implement `getPostById(postId: string)` method in `apps/api/src/posts/posts.service.ts`
  - [ ] Include author information and comments in the response
  - [ ] Add proper error handling for invalid post IDs
  - [ ] Add authentication guard (optional, for public posts)
  - [ ] Add OpenAPI documentation for the endpoint

- [ ] **Task 2: Create Post Detail DTOs** (AC: 1)
  - [ ] Create `PostDetailResponseDto` in `apps/api/src/posts/dto/post-detail-response.dto.ts`
  - [ ] Include post data, author information, and comments array
  - [ ] Add proper TypeScript types and validation
  - [ ] Update shared types in `packages/shared-types/src/index.ts`
  - [ ] Add comment DTOs for comment data structure

- [ ] **Task 3: Create Post Detail Page Route** (AC: 2)
  - [ ] Create `apps/web/app/posts/[postId]/page.tsx` with dynamic routing
  - [ ] Implement server-side data fetching for post details
  - [ ] Add proper loading and error states
  - [ ] Handle invalid post IDs with 404 page
  - [ ] Add metadata for SEO

- [ ] **Task 4: Create Post Detail Component** (AC: 4)
  - [ ] Create `PostDetail` component in `apps/web/components/posts/PostDetail.tsx`
  - [ ] Display post image with proper aspect ratio
  - [ ] Show author information and caption
  - [ ] Display comments list below the post
  - [ ] Add responsive design for mobile and desktop
  - [ ] Ensure accessibility features

- [ ] **Task 5: Add Navigation from Feed** (AC: 3)
  - [ ] Update `PostCard` component to be clickable
  - [ ] Add click handler to navigate to post detail page
  - [ ] Ensure proper link behavior and accessibility
  - [ ] Add hover effects for better UX
  - [ ] Update profile page posts to link to detail page

- [ ] **Task 6: Create Comments List Component** (AC: 4)
  - [ ] Create `CommentsList` component in `apps/web/components/posts/CommentsList.tsx`
  - [ ] Display comments in chronological order
  - [ ] Show comment author, text, and timestamp
  - [ ] Add loading states for comments
  - [ ] Handle empty comments state
  - [ ] Add proper styling and spacing

- [ ] **Task 7: Add Post Detail API Integration** (AC: 1)
  - [ ] Add `getPostById(postId: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add caching for post detail data
  - [ ] Handle authentication requirements
  - [ ] Add retry functionality for failed requests

- [ ] **Task 8: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/posts/PostDetail.test.tsx` with unit tests
  - [ ] Create `apps/web/components/posts/CommentsList.test.tsx` with unit tests
  - [ ] Test post detail page routing and data fetching
  - [ ] Create backend tests for single post endpoint in `apps/api/src/posts/posts.service.test.ts`
  - [ ] Add E2E tests with Playwright for post detail navigation
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Epic 3 (Post Creation) provides the posts table and Post entity
- Story 3.4 (Personalized Main Feed UI) provides the PostCard component
- User authentication system fully functional with Auth.js integration
- Database schema includes users, posts, and follows tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Post Detail Response** [Based on architecture patterns]:

```typescript
interface PostDetailResponse {
  id: string;
  imageUrl: string;
  caption?: string;
  createdAt: Date;
  author: {
    id: string;
    username: string;
    fullName: string;
    profilePictureUrl?: string;
  };
  comments: Array<{
    id: string;
    text: string;
    createdAt: Date;
    author: {
      id: string;
      username: string;
      fullName: string;
      profilePictureUrl?: string;
    };
  }>;
}
```

**Post Detail Page Props**:

```typescript
interface PostDetailPageProps {
  params: {
    postId: string;
  };
}
```

### API Specifications

**Single Post Endpoint** [Source: architecture/05-api-specification.md]:

- `GET /api/posts/{postId}` - Get single post by ID with comments
- Response: Post detail with author information and comments array
- Error handling: 404 for invalid post ID

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Backend Controller: `apps/api/src/posts/posts.controller.ts`
- Backend Service: `apps/api/src/posts/posts.service.ts`
- DTOs: `apps/api/src/posts/dto/post-detail-response.dto.ts`
- Frontend Page: `apps/web/app/posts/[postId]/page.tsx`
- Post Detail Component: `apps/web/components/posts/PostDetail.tsx`
- Comments List: `apps/web/components/posts/CommentsList.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Tests: `apps/web/components/posts/PostDetail.test.tsx`
- Backend Tests: `apps/api/src/posts/posts.service.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Posts table with proper indexing for ID queries
- Comments table with foreign key relationships
- User table with profile information

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Global exception filter for consistent error responses

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Dynamic routes with `[postId]` parameter
- Server-side data fetching for SEO
- Responsive design for mobile and desktop

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/posts/PostDetail.test.tsx`
- Backend tests: `apps/api/src/posts/posts.service.test.ts`
- Integration tests: `apps/api/test/posts.integration.test.ts`
- E2E tests: `e2e/post-detail.test.ts`

### Key Dependencies

- TypeORM for database operations and relationship queries
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Next.js App Router for dynamic routing
- Shared types from `packages/shared-types`

## Testing

- Unit tests for PostDetail and CommentsList components with 80%+ coverage
- Backend tests for single post endpoint logic
- Integration tests for API endpoints with real database
- E2E tests with Playwright for post detail navigation
- Test error handling for invalid post IDs
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
