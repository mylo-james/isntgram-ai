# Story 2.1: Follow/Unfollow Backend Logic

**Status**: Draft

## Story

**As a developer**, I want to create the backend logic and API endpoints to allow one user to follow or unfollow
another, so that the social graph relationships can be stored and managed.

## Acceptance Criteria

1. A Follows data model (or equivalent relationship) is created to link a `followerId` to a `followingId`.
2. A unique constraint is in place to prevent a user from following the same person more than once.
3. A `POST /api/users/{username}/follow` endpoint is created that, for the authenticated user, creates a new follow
   relationship with the specified user.
4. A `DELETE /api/users/{username}/follow` endpoint is created that, for the authenticated user, removes an existing
   follow relationship.
5. The API prevents users from attempting to follow themselves.
6. The endpoints are protected and require user authentication.

## Tasks / Subtasks

- [ ] **Task 1: Create Follows Entity and Migration** (AC: 1, 2)
  - [ ] Create `Follows` entity in `apps/api/src/follows/entities/follows.entity.ts` with TypeORM decorators
  - [ ] Define composite unique constraint on `followerId` and `followingId` columns
  - [ ] Create migration file for follows table with proper indexes
  - [ ] Add foreign key constraints to users table
  - [ ] Update User entity to include follower/following relationships

- [ ] **Task 2: Create Follows Service** (AC: 1, 2, 5)
  - [ ] Create `FollowsService` in `apps/api/src/follows/follows.service.ts`
  - [ ] Implement `followUser(followerId: string, followingId: string)` method
  - [ ] Implement `unfollowUser(followerId: string, followingId: string)` method
  - [ ] Add validation to prevent self-following
  - [ ] Add validation to prevent duplicate follows
  - [ ] Add proper error handling for edge cases

- [ ] **Task 3: Create Follows Controller** (AC: 3, 4, 6)
  - [ ] Create `FollowsController` in `apps/api/src/follows/follows.controller.ts`
  - [ ] Implement `POST /api/users/{username}/follow` endpoint
  - [ ] Implement `DELETE /api/users/{username}/follow` endpoint
  - [ ] Add authentication guard to both endpoints
  - [ ] Add proper request validation and error responses
  - [ ] Add OpenAPI documentation for endpoints

- [ ] **Task 4: Create Follows Module** (AC: All)
  - [ ] Create `FollowsModule` in `apps/api/src/follows/follows.module.ts`
  - [ ] Configure TypeORM repository for Follows entity
  - [ ] Register service and controller in module
  - [ ] Export service for use in other modules
  - [ ] Import module in main AppModule

- [ ] **Task 5: Update User Service for Counts** (AC: 1)
  - [ ] Update `UsersService` to include follower/following counts in user profile
  - [ ] Add methods to get follower and following counts
  - [ ] Ensure counts are updated when follows/unfollows occur
  - [ ] Update existing user profile endpoints to include counts

- [ ] **Task 6: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/api/src/follows/follows.service.test.ts` with unit tests
  - [ ] Create `apps/api/src/follows/follows.controller.test.ts` with controller tests
  - [ ] Create integration tests in `apps/api/test/follows.integration.test.ts`
  - [ ] Test all edge cases: self-following, duplicate follows, invalid users
  - [ ] Test authentication requirements and error responses
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Story 1.9 (Demo Mode Access) is currently In Progress but provides context on current authentication system
- Auth.js integration is fully functional with credentials provider
- Users API provides `GET /users/:username`, `GET /users/me`, `PUT /users/profile`
- Authentication system uses JWT-based strategy with NestJS Guards
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Follows Entity** [Source: architecture/04-data-models.md#follows]:

```typescript
export interface Follows {
  followerId: string;
  followingId: string;
  createdAt: Date;
}
```

**User Entity Updates** [Source: architecture/04-data-models.md#user]:

- User interface already includes `followerCount: number` and `followingCount: number`
- Relationships: User has many Follows (as follower and following)

### API Specifications

**Follow Endpoints** [Source: architecture/05-api-specification.md]:

- `POST /api/users/{username}/follow` - Follow a user
- `DELETE /api/users/{username}/follow` - Unfollow a user
- `GET /api/users/{username}/followers` - Get user's followers (for future stories)
- `GET /api/users/{username}/following` - Get users being followed (for future stories)

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Entity: `apps/api/src/follows/entities/follows.entity.ts`
- Service: `apps/api/src/follows/follows.service.ts`
- Controller: `apps/api/src/follows/follows.controller.ts`
- Module: `apps/api/src/follows/follows.module.ts`
- Migration: `apps/api/src/migrations/{timestamp}-CreateFollowsTable.ts`
- Tests: `apps/api/src/follows/follows.service.test.ts`, `apps/api/src/follows/follows.controller.test.ts`
- Integration tests: `apps/api/test/follows.integration.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Denormalized counts for performance optimization
- Composite unique constraint on followerId + followingId
- Foreign key constraints to users table
- Proper indexing on frequently queried columns

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- Global exception filter for consistent error responses
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations

**Authentication & Security** [Source: architecture/11-security.md]:

- JWT-based authentication using NestJS Guards
- Session cookies from Auth.js validation
- Input validation and sanitization
- Protected endpoints requiring authentication

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest for service and utility functions (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- Tests co-located with source code
- Custom Jest matchers for domain-specific assertions
- Mock data factories for consistent test data

**Test Organization**:

- Unit tests: `apps/api/src/follows/follows.service.test.ts`
- Controller tests: `apps/api/src/follows/follows.controller.test.ts`
- Integration tests: `apps/api/test/follows.integration.test.ts`
- Test utilities: `apps/api/test/setup.ts`

### Key Dependencies

- TypeORM for database operations and entity management
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Shared types from `packages/shared-types`

## Testing

- Unit tests for FollowsService with 80%+ coverage
- Controller tests for API endpoints and authentication
- Integration tests with real database interactions
- Test edge cases: self-following, duplicate follows, invalid users
- Test authentication requirements and error responses
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
