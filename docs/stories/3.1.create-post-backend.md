# Story 3.1: Create Post Backend

**Status**: Draft

## Story

**As a developer**, I want to create the data model and API endpoint for creating a new post, so that users' content can
be saved to the application.

## Acceptance Criteria

1. A Post data model is created that includes fields for an image URL, a caption, an author ID (`userId`), and
   timestamps.
2. A protected `POST /api/posts` endpoint is created that requires user authentication.
3. The endpoint validates the input (e.g., caption length limits, presence of an image URL).
4. A new post record is successfully created in the database and associated with the authenticated user.

## Tasks / Subtasks

- [ ] **Task 1: Create Post Entity and Migration** (AC: 1)
  - [ ] Create `Post` entity in `apps/api/src/posts/entities/post.entity.ts` with TypeORM decorators
  - [ ] Define fields: id, imageUrl, caption, authorId, createdAt, updatedAt
  - [ ] Add foreign key relationship to User entity
  - [ ] Create migration file for posts table with proper indexes
  - [ ] Add validation decorators for caption length and required fields

- [ ] **Task 2: Create Post Service** (AC: 1, 4)
  - [ ] Create `PostsService` in `apps/api/src/posts/posts.service.ts`
  - [ ] Implement `createPost(createPostDto: CreatePostDto, userId: string)` method
  - [ ] Add validation logic for caption length and image URL format
  - [ ] Ensure post is properly associated with authenticated user
  - [ ] Add proper error handling for database operations

- [ ] **Task 3: Create Post Controller** (AC: 2, 3)
  - [ ] Create `PostsController` in `apps/api/src/posts/posts.controller.ts`
  - [ ] Implement `POST /api/posts` endpoint with authentication guard
  - [ ] Add request validation using DTOs and class-validator
  - [ ] Add proper error responses and success responses
  - [ ] Add OpenAPI documentation for the endpoint

- [ ] **Task 4: Create Post DTOs** (AC: 3)
  - [ ] Create `CreatePostDto` in `apps/api/src/posts/dto/create-post.dto.ts`
  - [ ] Add validation decorators for caption length limits
  - [ ] Add validation for image URL format and presence
  - [ ] Create `PostResponseDto` for API responses
  - [ ] Update shared types in `packages/shared-types/src/index.ts`

- [ ] **Task 5: Create Posts Module** (AC: All)
  - [ ] Create `PostsModule` in `apps/api/src/posts/posts.module.ts`
  - [ ] Configure TypeORM repository for Post entity
  - [ ] Register service and controller in module
  - [ ] Export service for use in other modules
  - [ ] Import module in main AppModule

- [ ] **Task 6: Update User Entity Relationships** (AC: 1)
  - [ ] Update `User` entity to include posts relationship
  - [ ] Add `posts` field with OneToMany relationship
  - [ ] Update user profile endpoints to include posts count
  - [ ] Ensure proper cascade options for post deletion

- [ ] **Task 7: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/api/src/posts/posts.service.test.ts` with unit tests
  - [ ] Create `apps/api/src/posts/posts.controller.test.ts` with controller tests
  - [ ] Create integration tests in `apps/api/test/posts.integration.test.ts`
  - [ ] Test validation scenarios: invalid caption length, missing image URL
  - [ ] Test authentication requirements and error responses
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Epic 2 (Social Graph) provides the foundation for user relationships
- User authentication system fully functional with Auth.js integration
- User profile system implemented with dynamic routing
- Database schema includes users and follows tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Post Entity** [Source: architecture/04-data-models.md#post]:

```typescript
export interface Post {
  id: string;
  authorId: string;
  imageUrl: string;
  caption?: string;
  likesCount: number;
  commentsCount: number;
  createdAt: Date;
  updatedAt: Date;
  author?: User; // Optional populated field
}
```

**Create Post DTO**:

```typescript
export class CreatePostDto {
  @IsString()
  @IsNotEmpty()
  @MaxLength(2200) // Instagram-like caption limit
  caption?: string;

  @IsString()
  @IsNotEmpty()
  @IsUrl()
  imageUrl: string;
}
```

### API Specifications

**Post Endpoints** [Source: architecture/05-api-specification.md]:

- `POST /api/posts` - Create a new post (requires authentication)
- `GET /api/posts` - Get personalized feed (for future stories)
- `GET /api/posts/{postId}` - Get single post (for future stories)

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Entity: `apps/api/src/posts/entities/post.entity.ts`
- Service: `apps/api/src/posts/posts.service.ts`
- Controller: `apps/api/src/posts/posts.controller.ts`
- Module: `apps/api/src/posts/posts.module.ts`
- DTOs: `apps/api/src/posts/dto/create-post.dto.ts`
- Migration: `apps/api/src/migrations/{timestamp}-CreatePostsTable.ts`
- Tests: `apps/api/src/posts/posts.service.test.ts`, `apps/api/src/posts/posts.controller.test.ts`
- Integration tests: `apps/api/test/posts.integration.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Posts table with proper indexing for author and timestamp queries
- Foreign key constraints to users table
- Denormalized counts for likes and comments (for future stories)

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Global exception filter for consistent error responses

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

**Validation Requirements**:

- Caption length limit: 2200 characters (Instagram-like)
- Image URL must be valid URL format
- Image URL is required for post creation
- User authentication required for all post operations

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest for service and utility functions (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/api/src/posts/posts.service.test.ts`
- Controller tests: `apps/api/src/posts/posts.controller.test.ts`
- Integration tests: `apps/api/test/posts.integration.test.ts`
- Test utilities: `apps/api/test/setup.ts`

### Key Dependencies

- TypeORM for database operations and entity management
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Shared types from `packages/shared-types`
- class-validator for DTO validation

## Testing

- Unit tests for PostsService with 80%+ coverage
- Controller tests for API endpoints and authentication
- Integration tests with real database interactions
- Test validation scenarios: caption length, image URL format
- Test authentication requirements and error responses
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
