# Story 3.4: Personalized Main Feed UI

**Status**: Draft

## Story

**As a user**, I want to see a feed of posts from people I follow on the home page, so that I can see relevant content.

## Acceptance Criteria

1. The home page (`/`) fetches and displays posts from the `GET /api/posts` endpoint.
2. Each post is displayed in a card format, showing the author's username, the post image, and the caption.
3. The feed implements infinite scroll, fetching the next page of results when the user nears the bottom of the list.
4. A loading state is clearly shown while the initial posts are being fetched.
5. A user-friendly message is shown if the user is not following anyone or if the users they follow have not posted yet
   (e.g., "Your feed is empty. Follow people to see their posts!").
6. The author's username on each post is a link to their profile page.

## Tasks / Subtasks

- [ ] **Task 1: Create Post Card Component** (AC: 2, 6)
  - [ ] Create `PostCard` component in `apps/web/components/posts/PostCard.tsx`
  - [ ] Display author username as clickable link to profile
  - [ ] Display post image with proper aspect ratio
  - [ ] Display post caption with proper formatting
  - [ ] Add post metadata (timestamp, like/comment counts for future stories)
  - [ ] Ensure responsive design for mobile and desktop

- [ ] **Task 2: Create Feed Component** (AC: 1, 3, 4)
  - [ ] Create `Feed` component in `apps/web/components/posts/Feed.tsx`
  - [ ] Implement infinite scroll using Intersection Observer API
  - [ ] Add loading states for initial load and pagination
  - [ ] Handle empty state with user-friendly message
  - [ ] Manage post list state and pagination
  - [ ] Add error handling for failed API calls

- [ ] **Task 3: Update Home Page** (AC: 1, 5)
  - [ ] Update `apps/web/app/page.tsx` to use Feed component
  - [ ] Add authentication check for personalized feed
  - [ ] Handle loading and error states
  - [ ] Add empty state message for users not following anyone
  - [ ] Ensure proper layout and styling

- [ ] **Task 4: Create Feed API Integration** (AC: 1, 3)
  - [ ] Add `getFeed(page?: number, limit?: number)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add pagination support for infinite scroll
  - [ ] Cache feed data for better performance
  - [ ] Handle authentication requirements

- [ ] **Task 5: Add Redux State Management** (AC: 1, 3)
  - [ ] Create `posts-slice.ts` in `apps/web/lib/store/`
  - [ ] Add actions for fetching feed, loading states, and pagination
  - [ ] Implement optimistic updates for new posts
  - [ ] Handle feed data caching and invalidation
  - [ ] Add selectors for feed data and loading states

- [ ] **Task 6: Implement Infinite Scroll** (AC: 3, 4)
  - [ ] Add intersection observer for scroll detection
  - [ ] Implement pagination logic with cursor-based loading
  - [ ] Add loading indicators for pagination
  - [ ] Handle edge cases (no more posts, network errors)
  - [ ] Optimize performance with virtual scrolling for large lists

- [ ] **Task 7: Add Empty State and Error Handling** (AC: 5)
  - [ ] Create `EmptyFeed` component for users not following anyone
  - [ ] Add error boundary for feed errors
  - [ ] Implement retry functionality for failed requests
  - [ ] Add user-friendly error messages
  - [ ] Provide suggestions for users to follow others

- [ ] **Task 8: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/posts/PostCard.test.tsx` with unit tests
  - [ ] Create `apps/web/components/posts/Feed.test.tsx` with unit tests
  - [ ] Test infinite scroll functionality and pagination
  - [ ] Test empty states and error handling
  - [ ] Add E2E tests with Playwright for complete feed experience
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Story 3.3 (Personalized Main Feed Backend) provides the `GET /api/posts` endpoint
- Epic 2 (Social Graph) provides user relationships and profile navigation
- User authentication system fully functional with Auth.js integration
- Redux store configured for user state management
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Feed Response** [Based on Story 3.3]:

```typescript
interface FeedResponse {
  posts: Array<{
    id: string;
    imageUrl: string;
    caption?: string;
    createdAt: Date;
    author: {
      id: string;
      username: string;
      fullName: string;
      profilePictureUrl?: string;
    };
  }>;
  pagination: {
    page: number;
    limit: number;
    total: number;
    hasMore: boolean;
    nextCursor?: string;
  };
}
```

**Post Card Props**:

```typescript
interface PostCardProps {
  post: {
    id: string;
    imageUrl: string;
    caption?: string;
    createdAt: Date;
    author: {
      id: string;
      username: string;
      fullName: string;
      profilePictureUrl?: string;
    };
  };
}
```

### API Specifications

**Feed Endpoint** [Source: architecture/05-api-specification.md]:

- `GET /api/posts` - Get personalized feed (requires authentication)
- Query parameters: `page`, `limit`, `cursor`
- Response: Paginated list of posts from followed users
- Default pagination: page=1, limit=20

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Post Card: `apps/web/components/posts/PostCard.tsx`
- Feed Component: `apps/web/components/posts/Feed.tsx`
- Home Page: `apps/web/app/page.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Redux Store: `apps/web/lib/store/posts-slice.ts`
- Tests: `apps/web/components/posts/PostCard.test.tsx`, `apps/web/components/posts/Feed.test.tsx`
- E2E Tests: `e2e/feed.test.ts`

### Technical Constraints

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- Centralized API client services layer

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- Immutable updates, no direct mutations
- JSDoc comments for all public APIs
- Co-located tests with source code

**Component Patterns** [Source: architecture/06-components.md]:

- Feature-sliced component organization
- Modern component template with styling after component logic
- Responsive design for mobile and desktop

**Performance Requirements**:

- Infinite scroll with efficient pagination
- Image lazy loading for better performance
- Virtual scrolling for large feed lists
- Proper caching and state management

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: Component integration testing with mocked API calls (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/posts/PostCard.test.tsx`, `apps/web/components/posts/Feed.test.tsx`
- Integration tests: `apps/web/lib/api-client.test.ts`
- E2E tests: `e2e/feed.test.ts`
- Test utilities: `apps/web/lib/test-utils.tsx`

### Key Dependencies

- React Testing Library for component testing
- Redux Toolkit for state management
- Tailwind CSS for styling
- Auth.js for authentication
- Intersection Observer API for infinite scroll
- Shared types from `packages/shared-types`

## Testing

- Unit tests for PostCard and Feed components with 80%+ coverage
- Integration tests for API integration and state management
- E2E tests with Playwright for complete feed experience
- Test infinite scroll, pagination, and empty states
- Test error handling and loading states
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
