# Story 1.6: CI Hardening, Coverage Enforcement, and Security Scans

**Status**: Approved

## Story

**As a developer**, I want our CI to be fast, reliable, and security-aware so that changes are validated with
deterministic tests, enforced coverage thresholds, and automated security checks.

## Acceptance Criteria

1. CI enforces code quality: ESLint (no autofix), TypeScript type checks, markdownlint.
2. Unit tests run per workspace with coverage; aggregated coverage thresholds are enforced in CI and cause failures when
   below targets.
3. Integration tests run against Postgres service in CI without flakiness; execution is serialized to avoid DB race
   conditions.
4. E2E tests run using Playwright with JUnit and HTML reports uploaded as artifacts.
5. Conditional execution is applied so docs-only changes do not trigger build/tests.
6. Test results (JUnit) and coverage artifacts are uploaded for all jobs; PR shows clear pass/fail.
7. CodeQL scan job is present for JavaScript/TypeScript and runs on PR and on a schedule.
8. A Docker build job validates the production Dockerfile builds successfully on CI.
9. Jest versions are consistent across workspaces or pinned to a compatible set so API and Web tests both pass on CI.
10. Secrets scanning (Gitleaks or equivalent) runs on PRs and a scheduled workflow; CI fails on findings; reports are
    uploaded.
11. Dependency vulnerability scanning gates CI (e.g., audit-ci/OSV) at level "high" and above; Dependabot updates are
    enabled for npm and GitHub Actions.
12. Container security scanning (Trivy) is performed on the built image; CycloneDX/SBOM is generated and uploaded.
13. PRs include inline test summaries/annotations from JUnit for unit/integration/e2e in addition to artifacts.
14. Branch protection rules are defined with required checks documented and, where possible, enforced via repo
    settings-as-code or instructions.

## Tasks / Subtasks

- [ ] Task 1: Stabilize and align test tooling (AC: 2, 3, 9)
  - [ ] Pin consistent Jest version(s) across workspaces or update API to support Jest 30
  - [ ] Ensure `apps/api` ts-jest setup is compatible with selected Jest version
  - [ ] Add JUnit reporter for Jest across projects
  - [ ] Ensure integration tests run with `--runInBand` in CI

- [ ] Task 2: Strengthen linting and type-check (AC: 1)
  - [ ] Update `apps/api` lint script to remove `--fix` and enforce `--max-warnings=0`
  - [ ] Ensure root lint runs markdownlint and workspace ESLint without mutation
  - [ ] Replace chained `cd` type-check with workspace scoping or project references

- [ ] Task 3: Coverage enforcement and artifacts (AC: 2, 6)
  - [ ] Run Jest with coverage for all projects in CI unit job
  - [ ] Run `npm run coverage:report` to enforce thresholds
  - [ ] Upload per-package coverage and aggregated coverage summary

- [ ] Task 4: CI orchestration and filters (AC: 5)
  - [ ] Add paths filter to skip heavy jobs for docs-only changes
  - [ ] Parallelize unit tests per workspace using a matrix

- [ ] Task 5: E2E reporting upgrades (AC: 4, 6, 13)
  - [ ] Add Playwright JUnit reporter file to artifacts
  - [ ] Publish JUnit summaries to PR (e.g., action-junit-report) for all test suites
  - [ ] Verify HTML report is uploaded always on failure

- [ ] Task 6: Security and build integrity (AC: 7, 8)
  - [ ] Add CodeQL workflow for javascript/typescript
  - [ ] Add Docker build validation job

- [ ] Task 7: Secrets scanning (AC: 10)
  - [ ] Add Gitleaks workflow on PRs and schedule; fail on findings; upload report/SARIF
  - [ ] Add a baseline/allowlist mechanism if needed to avoid legacy noise

- [ ] Task 8: Dependency security (AC: 11)
  - [ ] Add `audit-ci` (or OSV scanner) step to CI with `--low` ignored and `--critical/high` gating
  - [ ] Add `.github/dependabot.yml` for npm and GitHub Actions ecosystems

- [ ] Task 9: Container security and SBOM (AC: 12)
  - [ ] Build Docker image in CI and scan with Trivy (fail on high+ severity)
  - [ ] Generate CycloneDX SBOM (e.g., via Anchore sbom-action) and upload as artifact

- [ ] Task 10: Governance (AC: 14)
  - [ ] Document required checks and branch protection configuration
  - [ ] If feasible, check in repo settings-as-code (e.g., github/safe-settings) for enforcement

## Dev Notes

- Keep Node 20 on CI for consistency with local dev.
- Prefer `actions/setup-node@v4` with `cache: npm`.
- Use `dorny/paths-filter` for conditional jobs.
- For stability, prefer pinning Jest 29 across monorepo now; plan a future upgrade.

## Testing

- PR should show separate checks for lint, type-check, unit (matrix), integration, e2e, codeql, docker build.
- Break the build when aggregated coverage thresholds fail.
- Verify artifacts: JUnit XML for Jest per project, Playwright JUnit/XML and HTML.

## Change Log

| Date       | Version | Description                               | Author             |
| ---------- | ------- | ----------------------------------------- | ------------------ |
| 2025-08-08 | 1.0     | Initial story creation                    | Bob (Scrum Master) |
| 2025-08-08 | 1.1     | Add gold-standard security and governance | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

James - Full Stack Developer (dev.md)

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD
