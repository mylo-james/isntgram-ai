# Story 4.3: Comment on a Post

**Status**: Draft

## Story

**As a user**, I want to add comments to a post, so that I can share my thoughts and interact with others.

## Acceptance Criteria

1. A Comment data model is created with fields for the comment text, `userId`, `postId`, and timestamps.
2. A protected `POST /api/posts/{postId}/comments` endpoint is created.
3. On the post detail page, a text input is available for writing a new comment.
4. Submitting the comment adds it to the database and updates the comment list in the UI without a full page reload.

## Tasks / Subtasks

- [ ] **Task 1: Create Comment Entity and Migration** (AC: 1)
  - [ ] Create `Comment` entity in `apps/api/src/comments/entities/comment.entity.ts`
  - [ ] Define fields: id, text, userId, postId, createdAt, updatedAt
  - [ ] Add foreign key relationships to User and Post entities
  - [ ] Create migration file for comments table with proper indexes
  - [ ] Add validation for comment text length

- [ ] **Task 2: Create Comments Service** (AC: 1, 2)
  - [ ] Create `CommentsService` in `apps/api/src/comments/comments.service.ts`
  - [ ] Implement `createComment(createCommentDto: CreateCommentDto, userId: string)` method
  - [ ] Add validation for comment text and post existence
  - [ ] Update post comment count when comments are added
  - [ ] Add proper error handling for edge cases

- [ ] **Task 3: Create Comments Controller** (AC: 2)
  - [ ] Create `CommentsController` in `apps/api/src/comments/comments.controller.ts`
  - [ ] Implement `POST /api/posts/{postId}/comments` endpoint
  - [ ] Add authentication guard and request validation
  - [ ] Add proper error responses and success responses
  - [ ] Add OpenAPI documentation for the endpoint

- [ ] **Task 4: Create Comments Module** (AC: All)
  - [ ] Create `CommentsModule` in `apps/api/src/comments/comments.module.ts`
  - [ ] Configure TypeORM repository for Comment entity
  - [ ] Register service and controller in module
  - [ ] Export service for use in other modules
  - [ ] Import module in main AppModule

- [ ] **Task 5: Create Comment Input Component** (AC: 3, 4)
  - [ ] Create `CommentInput` component in `apps/web/components/posts/CommentInput.tsx`
  - [ ] Add textarea for comment input with character limit
  - [ ] Add submit button with loading state
  - [ ] Implement form validation and error handling
  - [ ] Add accessibility features and keyboard shortcuts

- [ ] **Task 6: Update Comments List Component** (AC: 4)
  - [ ] Update `CommentsList` component to handle new comments
  - [ ] Add optimistic updates for new comments
  - [ ] Implement real-time comment addition
  - [ ] Add proper loading states and error handling
  - [ ] Ensure proper comment ordering

- [ ] **Task 7: Integrate with Post Detail Page** (AC: 3, 4)
  - [ ] Update `PostDetail` component to include CommentInput
  - [ ] Pass post ID and user information to CommentInput
  - [ ] Handle comment submission and list updates
  - [ ] Add proper error handling and user feedback
  - [ ] Update comment count display

- [ ] **Task 8: Add Frontend API Integration** (AC: 4)
  - [ ] Add `createComment(postId: string, text: string)` method to `apps/web/lib/api-client.ts`
  - [ ] Implement proper error handling and loading states
  - [ ] Add optimistic updates for better UX
  - [ ] Handle authentication requirements
  - [ ] Add retry functionality for failed requests

- [ ] **Task 9: Update Redux Store for Comments** (AC: 4)
  - [ ] Add comment creation actions to `apps/web/lib/store/posts-slice.ts`
  - [ ] Update post state to include comments array
  - [ ] Implement optimistic updates for new comments
  - [ ] Handle error cases and rollback optimistic updates
  - [ ] Ensure state consistency across components

- [ ] **Task 10: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create `apps/web/components/posts/CommentInput.test.tsx` with unit tests
  - [ ] Test comment creation functionality and validation
  - [ ] Create backend tests for comments endpoints in `apps/api/src/comments/comments.service.test.ts`
  - [ ] Test API integration and error handling
  - [ ] Add E2E tests with Playwright for comment creation flow
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Epic 3 (Post Creation) provides the posts table and Post entity
- Story 4.1 (Single Post Detail Page) provides the PostDetail and CommentsList components
- User authentication system fully functional with Auth.js integration
- Database schema includes users and posts tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Comment Entity** [Source: architecture/04-data-models.md#comment]:

```typescript
export interface Comment {
  id: string;
  authorId: string;
  postId: string;
  text: string;
  likesCount: number;
  createdAt: Date;
  updatedAt: Date;
  author?: User; // Optional populated field
}
```

**Create Comment DTO**:

```typescript
export class CreateCommentDto {
  @IsString()
  @IsNotEmpty()
  @MaxLength(1000) // Reasonable comment length limit
  text: string;
}
```

### API Specifications

**Comment Endpoints** [Source: architecture/05-api-specification.md]:

- `POST /api/posts/{postId}/comments` - Create a new comment (requires authentication)
- Request body: `{ text: string }`
- Response: Created comment with author information

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Entity: `apps/api/src/comments/entities/comment.entity.ts`
- Service: `apps/api/src/comments/comments.service.ts`
- Controller: `apps/api/src/comments/comments.controller.ts`
- Module: `apps/api/src/comments/comments.module.ts`
- Frontend Component: `apps/web/components/posts/CommentInput.tsx`
- Integration: `apps/web/components/posts/PostDetail.tsx`
- API Client: `apps/web/lib/api-client.ts`
- Redux Store: `apps/web/lib/store/posts-slice.ts`
- Tests: `apps/web/components/posts/CommentInput.test.tsx`
- Backend Tests: `apps/api/src/comments/comments.service.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Comments table with foreign key relationships
- Proper indexing for post and user queries
- Denormalized comment count in posts table

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Global exception filter for consistent error responses

**Frontend Architecture** [Source: architecture/08-project-structure.md]:

- Next.js App Router for file-system-based routing
- Redux Toolkit for global state management
- Tailwind CSS for styling
- Centralized API client services layer

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest + React Testing Library for component testing (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/web/components/posts/CommentInput.test.tsx`
- Backend tests: `apps/api/src/comments/comments.service.test.ts`
- Integration tests: `apps/api/test/comments.integration.test.ts`
- E2E tests: `e2e/comment-post.test.ts`

### Key Dependencies

- TypeORM for database operations and relationships
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Redux Toolkit for state management
- Shared types from `packages/shared-types`

## Testing

- Unit tests for CommentInput component with 80%+ coverage
- Backend tests for comments endpoints and service logic
- Integration tests for API endpoints with real database
- E2E tests with Playwright for comment creation flow
- Test optimistic updates and error handling
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
