# Story 3.3: Personalized Main Feed Backend

**Status**: Draft

## Story

**As a developer**, I want a backend endpoint that retrieves posts only from users I follow, so that I can populate a
personalized main feed.

## Acceptance Criteria

1. A `GET /api/posts` endpoint is created.
2. The endpoint returns a paginated list of posts only from users that the current authenticated user is following,
   sorted with the newest posts first.
3. Each post object in the response includes the post's ID, image URL, caption, creation date, and necessary information
   about the author (e.g., username, profile picture URL).
4. The endpoint must support pagination (e.g., using a cursor or limit/offset) to enable infinite scroll.

## Tasks / Subtasks

- [ ] **Task 1: Update Posts Service for Feed Logic** (AC: 2, 3)
  - [ ] Add `getPersonalizedFeed(userId: string, page: number, limit: number)` to `apps/api/src/posts/posts.service.ts`
  - [ ] Implement database query to join posts with follows table
  - [ ] Filter posts to only include users the current user follows
  - [ ] Sort posts by creation date (newest first)
  - [ ] Include author information in post objects
  - [ ] Add proper error handling for database operations

- [ ] **Task 2: Update Posts Controller for Feed Endpoint** (AC: 1, 4)
  - [ ] Add `GET /api/posts` endpoint to `apps/api/src/posts/posts.controller.ts`
  - [ ] Implement pagination parameters (page, limit) with defaults
  - [ ] Add authentication guard to ensure user is logged in
  - [ ] Add proper request validation for pagination parameters
  - [ ] Add OpenAPI documentation for the endpoint

- [ ] **Task 3: Create Feed Response DTOs** (AC: 3)
  - [ ] Create `FeedResponseDto` in `apps/api/src/posts/dto/feed-response.dto.ts`
  - [ ] Create `PostWithAuthorDto` for individual post objects
  - [ ] Include pagination metadata in response
  - [ ] Add proper TypeScript types and validation
  - [ ] Update shared types in `packages/shared-types/src/index.ts`

- [ ] **Task 4: Implement Efficient Database Queries** (AC: 2, 4)
  - [ ] Optimize database query with proper JOINs
  - [ ] Add database indexes for follows and posts tables
  - [ ] Implement cursor-based pagination for better performance
  - [ ] Add query optimization for large datasets
  - [ ] Handle edge cases (user not following anyone, no posts)

- [ ] **Task 5: Add Feed Caching Strategy** (AC: 2, 4)
  - [ ] Implement Redis caching for feed data
  - [ ] Add cache invalidation when new posts are created
  - [ ] Set appropriate cache TTL for feed freshness
  - [ ] Handle cache misses gracefully
  - [ ] Add cache warming for active users

- [ ] **Task 6: Update Posts Repository** (AC: 2, 3)
  - [ ] Add custom repository methods for feed queries
  - [ ] Implement efficient TypeORM query builder usage
  - [ ] Add proper eager loading for author relationships
  - [ ] Optimize query performance with select statements
  - [ ] Add query logging for performance monitoring

- [ ] **Task 7: Create Comprehensive Tests** (Testing Requirements)
  - [ ] Create unit tests for feed logic in `apps/api/src/posts/posts.service.test.ts`
  - [ ] Test pagination functionality and edge cases
  - [ ] Create integration tests in `apps/api/test/posts.integration.test.ts`
  - [ ] Test authentication requirements and error responses
  - [ ] Test feed filtering and sorting logic
  - [ ] Ensure 80%+ test coverage for new code

## Dev Notes

### Previous Story Insights

- Story 3.1 (Create Post Backend) provides the posts table and Post entity
- Epic 2 (Social Graph) provides the follows table and relationships
- User authentication system fully functional with Auth.js integration
- Database schema includes users, posts, and follows tables
- Current test coverage: 30/30 suites passing across web/api/shared

### Data Models

**Feed Response** [Based on architecture patterns]:

```typescript
interface FeedResponse {
  posts: Array<{
    id: string;
    imageUrl: string;
    caption?: string;
    createdAt: Date;
    author: {
      id: string;
      username: string;
      fullName: string;
      profilePictureUrl?: string;
    };
  }>;
  pagination: {
    page: number;
    limit: number;
    total: number;
    hasMore: boolean;
    nextCursor?: string;
  };
}
```

**Feed Query Parameters**:

```typescript
interface FeedQueryParams {
  page?: number;
  limit?: number;
  cursor?: string;
}
```

### API Specifications

**Feed Endpoint** [Source: architecture/05-api-specification.md]:

- `GET /api/posts` - Get personalized feed (requires authentication)
- Query parameters: `page`, `limit`, `cursor`
- Response: Paginated list of posts from followed users
- Default pagination: page=1, limit=20

### File Locations

Based on project structure [Source: architecture/08-project-structure.md]:

- Service: `apps/api/src/posts/posts.service.ts`
- Controller: `apps/api/src/posts/posts.controller.ts`
- DTOs: `apps/api/src/posts/dto/feed-response.dto.ts`
- Repository: `apps/api/src/posts/posts.repository.ts`
- Tests: `apps/api/src/posts/posts.service.test.ts`
- Integration tests: `apps/api/test/posts.integration.test.ts`

### Technical Constraints

**Database Schema** [Source: architecture/07-database-schema.md]:

- PostgreSQL with TypeORM
- Posts table with proper indexing for author and timestamp queries
- Follows table with proper indexing for follower/following queries
- Foreign key constraints between users, posts, and follows tables

**Backend Architecture** [Source: architecture/08-project-structure.md]:

- NestJS with feature-based modular structure
- Repository Pattern using TypeORM
- JWT-based authentication strategy
- Global exception filter for consistent error responses

**Performance Requirements**:

- Support for large datasets with efficient pagination
- Cursor-based pagination for better performance
- Database query optimization with proper indexes
- Caching strategy for frequently accessed feeds

**Coding Standards** [Source: architecture/10-coding-standards.md]:

- TypeScript strict mode with no implicit any
- Use shared types from `packages/shared-types`
- JSDoc comments for all public APIs
- Immutable updates, no direct mutations
- Co-located tests with source code

### Testing Requirements

**Testing Strategy** [Source: architecture/09-testing-strategy.md]:

- TDD methodology with 95%+ coverage target
- Unit tests: Jest for service and utility functions (80%+ coverage)
- Integration tests: API endpoint testing with real database (15%+ coverage)
- E2E tests: Playwright for critical user journey testing (5%+ coverage)

**Test Organization**:

- Unit tests: `apps/api/src/posts/posts.service.test.ts`
- Controller tests: `apps/api/src/posts/posts.controller.test.ts`
- Integration tests: `apps/api/test/posts.integration.test.ts`
- Test utilities: `apps/api/test/setup.ts`

### Key Dependencies

- TypeORM for database operations and relationship queries
- NestJS Guards for authentication
- Auth.js for session management
- Jest for testing framework
- Redis for caching (optional)
- Shared types from `packages/shared-types`

## Testing

- Unit tests for feed logic with 80%+ coverage
- Controller tests for API endpoints and pagination
- Integration tests with real database interactions
- Test pagination functionality and edge cases
- Test feed filtering and sorting logic
- Follow TDD methodology: write failing test first, implement minimal code, refactor

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-XX | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

To be populated by development agent.

### Debug Log References

To be populated by development agent.

### Completion Notes List

To be populated by development agent.

### File List

To be populated by development agent.

## QA Results

To be populated by QA agent.
